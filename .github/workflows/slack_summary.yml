name: Weekly Slack Summary

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  summarize:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install slack-sdk google-generativeai
        pip list
    
    - name: Verify environment
      env:
        SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "Checking environment variables..."
        if [ -z "$SLACK_USER_TOKEN" ]; then
          echo "ERROR: SLACK_USER_TOKEN is not set"
          exit 1
        fi
        if [ -z "$GEMINI_API_KEY" ]; then
          echo "ERROR: GEMINI_API_KEY is not set"
          exit 1
        fi
        echo "Token length: ${#SLACK_USER_TOKEN}"
        echo "First 10 chars of token: ${SLACK_USER_TOKEN:0:10}"
        echo "Environment verified successfully!"
    
    - name: Run summarizer
      env:
        SLACK_USER_TOKEN: ${{ secrets.SLACK_USER_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "Starting Slack summarizer..."
        python slack_summarizer.py
        echo "Summarizer completed!"
    
    - name: Check output
      run: |
        echo "Checking if summary was generated..."
        if [ -f "summaries/weekly_summary.md" ]; then
          echo "Summary file found!"
          echo "File size: $(wc -c < summaries/weekly_summary.md) bytes"
          echo "Line count: $(wc -l < summaries/weekly_summary.md) lines"
          echo ""
          echo "First 50 lines of summary:"
          head -50 summaries/weekly_summary.md
        else
          echo "WARNING: Summary file not found!"
          ls -la summaries/ || echo "summaries directory doesn't exist"
        fi
    
    - name: Commit and push summary
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add summaries/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ“Š Weekly Slack summary - $(date +'%Y-%m-%d')"
          git push
          echo "Summary committed and pushed!"
        fi
